<!doctype html>
<html lang=en>
<head>
    <meta charset=utf-8>
    <title>Mosab Ahmad</title>
    <meta name=author content="Mosab Ahmad">
    <link href="./theme/local.css" rel=stylesheet>
    <script>function script(src) {
        var d = document, s = d.createElement('script');
        s.async = true; s.src = src; d.body.appendChild(s);
    }</script>
    
        <meta property="og:type"            content="website" />
    <meta property="og:url"             content="./poor-mans-guide-for-monitoring-a-website-in-python.html" />
    <meta property="og:title"           content="Poor Man's Guide for Monitoring a Website in Python | Mosab Ahmad" />
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=141545232609877";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<header class=top>
    <div class="top-menu">
    	<a class=brand href=".">Mosab Ahmad</a>
    	<div style=float:right>
        	        	<a href="./about.html">About</a>
        	        	<a href="./projects.html">Projects</a>
        	    	</div>
    </div>
</header>

<section>
    <article>
        <article>
    <header>
        <h1>Poor Man's Guide for Monitoring a Website in Python</h1>
        <time>11 Feb, 2013</time>    </header>

    <p><p>In one of the projects I am working on there was a problem with Apache
server. It went down almost on a daily basis, and we were reading the
logs to get the bottom of the root cause. But untill we got our solution
we needed to monitor the server's accssibility through the web, and get
alerted if it went down, and ultimately restart it when this happened.</p>
<p>So I fired up my console and text editor and started hacking a little
script to do the above mentioned side goals.</p>
<ol>
<li>Monitoring the Apache server's accessiblity from a different server.</li>
<li>SSH-ing the linux box running the server and restarting Apache.</li>
<li>Alerting the DevOps team about the issue.</li>
<li>Putting it all together</li>
<li>Setting up a cron job to run the script</li>
</ol>
<p>I am assuming you are running an ubunut machine.</p>
<h3 id="146-monitoring-the-apache-server">1. Monitoring the Apache Server</h3>
<p>I was confused between two <code>Python 2.x</code> libraries (note that they are
dramatically changed in <code>Python 3.x</code> and choosing between them is
subject to different ciretera).</p>
<p>The first library was <code>python-httplib</code> and the second was <code>urllib</code>.
After a quick reading through both library's manual and a quick reading
on StackOverflow I have decided to go for urllib.</p>
<p>Basically what I had in mind was to send a GET request to the website
served by Apache and check the HTTP response code I got.</p>
<p>If it is <em>200</em> -which is the SUCCESS response code according to HTTP
standards- then everything is fine.</p>
<p>You can try this in a python interactive shell :</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">urllib</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">response_code</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://www.example.com&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">response_code</span>
<span class="mi">200</span>
</pre></div>


<p>If the printed value is 200 then the website is up and running, if it
has a different value or raises an Exception then the site is likely
down (Assuming you have internet connectivity, no firewalls blocking
your way, etc).</p>
<p>Time to put it together in a script :</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">urllib</span>

<span class="k">try</span><span class="p">:</span>    
    <span class="n">resposne_code</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://www.example.com&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>    
    <span class="k">if</span> <span class="n">response_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>        
        <span class="k">raise</span> <span class="ne">ValueError</span>
<span class="k">except</span><span class="p">:</span>    
    <span class="k">pass</span>    
        <span class="c"># Here write code to do whatever you want to do when the website is down.</span>
</pre></div>


<h3 id="246-restart-the-apache-server-remotely">2. Restart the Apache server remotely</h3>
<p>There is a wonderful Python library and a command-line tool called
<em><a href="http://docs.fabfile.org/en/1.5/">Fabric</a></em> that helps you streamlining the use of SSH for application
deployment or systems administration tasks. It is ideally used to
automate tedious error prone tasks in an easy way.</p>
<p>You can read about more about it in their documentation.</p>
<p>Install it by running the following command:</p>
<div class="codehilite"><pre><span class="nv">$ </span>sudo apt-get install fabric
</pre></div>


<p>We now need to create a new python file that I will name <code>fabfile.py</code>,
you can name it anything, but let's just follow the common name you will
see in Fabric's documenation.</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span><span class="p">,</span> <span class="n">sudo</span>

<span class="n">env</span><span class="o">.</span><span class="n">hosts</span>       <span class="o">=</span> <span class="p">[</span><span class="s">&#39;user@server&#39;</span><span class="p">]</span>
<span class="n">env</span><span class="o">.</span><span class="n">passwords</span>   <span class="o">=</span> <span class="p">{</span><span class="s">&#39;user@server&#39;</span> <span class="p">:</span> <span class="s">&#39;password&#39;</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">restart_apache</span><span class="p">():</span>    
    <span class="n">sudo</span><span class="p">(</span><span class="s">&quot;apache2ctl restart&quot;</span><span class="p">)</span>
</pre></div>


<p>We start by importing what we need from Fabric. Then we tell it some
information about the server we want to restart Apache on by setting the
<code>env.hosts</code> and <code>env.passwords</code> variables.</p>
<p>Then we define a <code>restart_apache</code> function that we will call later to do
the actual restart.</p>
<p>There are three main functions that are used the most, <code>local()</code> that
runs local commands, <code>run()</code> that runs commands on the remote server and
<code>sudo()</code> that runs commands on the remote server using <code>sudo</code>. Since
Apache restart requires a root user or sudo priveleges we used the
<code>sudo()</code> function.</p>
<p>To run a Fabric script open up your terminal and run the following
command:</p>
<div class="codehilite"><pre><span class="nv">$ </span>fabric fabfile.py restart_apache
</pre></div>


<p>If you want to run it from a different directory than the <code>fabfile.py</code>
then you need to use the <code>-f</code> option like this :</p>
<div class="codehilite"><pre><span class="nv">$ </span>fabric -f /path/to/your/fabfile.py function_name
</pre></div>


<h3 id="346-alerting-the-devops-team-about-the-issue">3. Alerting the DevOps team about the issue.</h3>
<p>We can re-use the email function from the previous post on this blog
<a href="http://www.mos3abof.com/installing-gdata-python-client-on-dreamhost.html">Installing Gdata Python Client on Dreamhost</a>:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">from</span> <span class="nn">email.MIMEMultipart</span> <span class="kn">import</span> <span class="n">MIMEMultipart</span>
<span class="kn">from</span> <span class="nn">email.MIMEBase</span> <span class="kn">import</span> <span class="n">MIMEBase</span>
<span class="kn">from</span> <span class="nn">email.MIMEText</span> <span class="kn">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span> <span class="nn">email</span> <span class="kn">import</span> <span class="n">Encoders</span>

<span class="n">subject</span>     <span class="o">=</span> <span class="s">&#39;Your website is down&#39;</span>
<span class="n">email_body</span>  <span class="o">=</span> <span class="s">&#39;Your website is down&#39;</span>
<span class="n">gmail_user</span>  <span class="o">=</span> <span class="s">&#39;YOUR-GMAIL-ADDRESS&#39;</span>
<span class="n">gmail_pwd</span>   <span class="o">=</span> <span class="s">&#39;YOUR-GMAIL-PASSWORD&#39;</span>
<span class="n">recepient</span>   <span class="o">=</span> <span class="s">&#39;DEVOPS-EMAIL&#39;</span>

<span class="k">def</span> <span class="nf">mail</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">gmail_user</span><span class="p">,</span> <span class="n">gmail_pwd</span><span class="p">):</span>    
    <span class="sd">&#39;&#39;&#39;    Sends mail using gmail    &#39;&#39;&#39;</span>    
    <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">()</span>    

    <span class="c"># Setting up message data    </span>
    <span class="n">msg</span><span class="p">[</span><span class="s">&#39;From&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&#39;DEVOPS-EMAIL&#39;</span>    
    <span class="n">msg</span><span class="p">[</span><span class="s">&#39;To&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">to</span>    
    <span class="n">msg</span><span class="p">[</span><span class="s">&#39;Subject&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">subject</span>    
    <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">MIMEText</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>    

    <span class="c"># Opening the connection with Gmail SMTP server    </span>
    <span class="n">mailServer</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s">&quot;smtp.gmail.com&quot;</span><span class="p">,</span> <span class="mi">587</span><span class="p">)</span>    
    <span class="n">mailServer</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>    
    <span class="n">mailServer</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>    
    <span class="n">mailServer</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>    
    <span class="n">mailServer</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">gmail_user</span><span class="p">,</span> <span class="n">gmail_pwd</span><span class="p">)</span>    

    <span class="c"># Actual sending of the email    </span>
    <span class="n">mailServer</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">gmail_user</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>    

    <span class="c"># Closing the connection    </span>
    <span class="c"># Should be mailServer.quit(), but that crashes    </span>
    <span class="n">mailServer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<h3 id="446-putting-it-all-together">4. Putting it all together</h3>
<p>I have combined all the snippets mentioned above, modified them and
added some logging functionality to it.</p>
<p>I have it installed on <code>/opt/fabfile.py</code> and I have created a <code>/opt/fab_logs</code> folder to hold the log files.</p>
<p>Below is how a complete script may look like.</p>
<p><script src="https://gist.github.com/mos3abof/4771874.js"></script></p>
<h3 id="546-setting-up-a-cron-job-to-run-the-script">5. Setting up a cron job to run the script</h3>
<p>Now we have a great script, and we know how to run it manually. But it
would be invonvenient to run it manually all the time. We need to setup
a cron job to do it periodically for us.</p>
<p>Run the following command in the terminal to edit your crontab file:</p>
<div class="codehilite"><pre>crontab -e
</pre></div>


<p>Then add the following line to the file to run the script every hour:</p>
<div class="codehilite"><pre>0 * * * * /usr/bin/fab -f /path/to/your/fabfile.py restart_apache
</pre></div>


<p>Happy website monitoring.</p></p>

    <hr>

    <div class=social-controls>

    <div class="fb-like" data-href="./poor-mans-guide-for-monitoring-a-website-in-python.html" data-send="true" data-width="400" data-show-faces="true"></div>

    
</div>
        <h2>Comments</h2>
    <div id=disqus_thread></div>
<script>script('http://mos3abof.disqus.com/embed.js')</script>
<noscript>Please enable JavaScript to view comments.</noscript>    </article>
    </article>

    <hr />

    <footer>
        <p>
            Site is built using
            <a href="http://docs.getpelican.com/en/latest/getting_started.html" target="_blank">Pelican</a>
            (static site generator, written in <a href="http://www.python.org" target="_blank">Python</a>),
            runs on <a href="https://developers.google.com/appengine/" target="_blank">Google AppEngine</a>,
            icons by <a href="http://simpleicons.org/" target="_blank">Simple Icons</a>
            and uses <a href="https://github.com/sharat87/sharats.me" target="_blank">Shrikant Sharat</a>'s theme.
            <br />
            &copy; All rights reserved to <a href=".">Mosab Ahmad</a> 2007 - 2013
        </p>
        <section class=social>
    		<a href="./feeds/all.atom.xml" target=_blank><img src="theme/img/rss.png" style="color: #FF8300; background-color: #FF8300;"></a>
    		<a href="http://github.com/mos3abof" target=_blank><img src="theme/img/github.png" style="color: #4183C4; background-color: #4183C4;"></a>
            <a href="https://bitbucket.org/mos3abof" target=_blank><img src="theme/img/bitbucket.png" style="color: #205081; background-color: #205081;"></a>
            <a href="http://linkedin.com/in/mosab" target=_blank><img src="theme/img/linkedin.png" style="color: #007FB1; background-color: #007FB1;"></a>
    		<a href="http://facebook.com/mos3abof" target=_blank><img style="color:#3B5998; background-color: #3B5998;"  src="theme/img/facebook.png" /></a>
            <a href="http://twitter.com/mos3abof" target=_blank><img src="theme/img/twitter.png" style="color: #00ACED; background-color: #00ACED;"></a>
            <a href="https://plus.google.com/103419053954297467507" target=_blank><img src="theme/img/googleplus.png" style="color: #D14836; background-color: #D14836;"></a>
    		<a href="http://stackoverflow.com/users/253214/mosab-ahmad" target=_blank><img src="theme/img/stackoverflow.png" style="color: #F47920; background-color: #F47920;"></a>
    		<a href="http://instagram.com/mos3abof" target=_blank><img src="theme/img/instagram.png" style="color: #3F729B; background-color: #3F729B;"></a>
    		<a href="http://www.flickr.com/photos/mos3abof/" target=_blank><img src="theme/img/flickr.png" style="color: #0063DB; background-color: #0063DB;"></a>
    		<a href="https://foursquare.com/mos3abof" target=_blank><img src="theme/img/foursquare.png" style="color: #2398C9; background-color: #2398C9;"></a>
            <a href="http://about.me/mosab.ahmad" target=_blank><img src="theme/img/aboutme.png" style="color: #00405D; background-color: #00405D;"></a>
            <a href="http://www.slideshare.net/mos3abof" target=_blank><img src="theme/img/slideshare.png" style="color: #009999; background-color: #009999;"></a>
            <a href="https://geekli.st//mos3abof" target=_blank><img src="theme/img/geeklist.png" style="color: #8CC63E; background-color: #8CC63E;"></a>
            <a href="https://soundcloud.com/mos3abof" target=_blank><img src="theme/img/soundcloud.png" style="color: #FF6600; background-color: #FF6600;"></a>
            <a href="http://www.pinterest.com/mos3abof/" target=_blank><img src="theme/img/pinterest.png" style="color: #CB2027; background-color: #CB2027;"></a>
            <a href="https://drupal.org/user/279579" target=_blank><img src="theme/img/drupal.png" style="color: #0077C0; background-color: #0077C0;"></a>
            <a href="http://en.wikipedia.org/wiki/User:Mos3abof" target=_blank><img src="theme/img/wikipedia.png" style="color: #000000; background-color: #000000;"></a>
            <a href="https://www.quora.com/Mosab-Ahmad" target=_blank><img src="theme/img/quora.png" style="color: #A82400; background-color: #A82400;"></a>
            <a href="skype:mos3abof?chat" target=_blank><img src="theme/img/skype.png" style="color: #00AFF0; background-color: #00AFF0;"></a>
        </section>
    </footer>
</section>

<script>script('//static.getclicky.com/js')</script>
<noscript><img width=1 height=1 src="//in.getclicky.com/100601461ns.gif"></noscript><script async src="./theme/main.js"></script>