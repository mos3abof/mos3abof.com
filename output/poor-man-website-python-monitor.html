<!doctype html>
<html lang=en>
<head>
    <meta charset=utf-8>
    <title>Mosab Ahmad</title>
    <meta name=author content="Mosab Ahmad">
    <link href="http://www.mos3abof.com/theme/local.css" rel=stylesheet>
    <script>function script(src) {
        var d = document, s = d.createElement('script');
        s.async = true; s.src = src; d.body.appendChild(s);
    }</script>
    
        <meta property="og:type"            content="website" />
    <meta property="og:url"             content="http://www.mos3abof.com/poor-man-website-python-monitor.html" />
    <meta property="og:title"           content="Poor Man's Guide for Monitoring a Website in Python | Mosab Ahmad" />
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=141545232609877";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<header class=top>
    <a class=brand href="http://www.mos3abof.com">Mosab Ahmad</a>
    <div style=float:right>
                <a href="http://www.mos3abof.com/pages/about.html">About</a>
                <a href="http://www.mos3abof.com/pages/projects.html">Projects</a>
                <a href="http://www.mos3abof.com/tags.html">Tags</a>
                <a href="http://www.mos3abof.com/feeds/all.atom.xml">Atom Feed</a>
            </div>
</header>

<section>
    <article>
        <article>
    <header>
        <h1>Poor Man's Guide for Monitoring a Website in Python</h1>
        <time>Mon, 11 Feb 2013</time>    </header>

    <p><p>In one of the projects I am working on there was a problem with Apache server. It went down almost on a daily basis, and we were reading the logs to get the bottom of the root cause. But untill we got our solution we needed to monitor the server's accssibility through the web, and get alerted if it went down, and ultimately restart it when this happened.</p>
<p>So I fired up my console and text editor and started hacking a little script to do the above mentioned side goals.</p>
<ol>
<li>Monitoring the Apache server's accessiblity from a different server.</li>
<li>SSH-ing the linux box running the server and restarting Apache.</li>
<li>Alerting the DevOps team about the issue.</li>
<li>Putting it all together</li>
<li>Setting up a cron job to run the script</li>
</ol>
<p>I am assuming you are running an ubunut machine.</p>
<h3 id="146-monitoring-the-apache-server">1. Monitoring the Apache Server</h3>
<p>I was confused between two <code>Python 2.x</code> libraries (note that they are dramatically changed in <code>Python 3.x</code> and choosing between them is subject to different ciretera).
The first library was <code>python-httplib</code> and the second was <code>urllib</code>. After a quick reading through both library's manual and a quick reading on StackOverflow I have decided to go for urllib.</p>
<p>Basically what I had in mind was to send a GET request to the website served by Apache and check the HTTP response code I got.
If it is <em>200</em> -which is the SUCCESS response code according to HTTP standards- then everything is fine.</p>
<p>You can try this in a python interactive shell :</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">urllib</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">response_code</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://www.example.com&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">response_code</span>
<span class="mi">200</span>
</pre></div>


<p>If the printed value is 200 then the website is up and running, if it has a different value or raises an Exception then the site is likely down (Assuming you have internet connectivity, no firewalls blocking your way, etc).</p>
<p>Time to put it together in a script :</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">urllib</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">resposne_code</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://www.example.com&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">response_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
    <span class="c"># Here write code to do whatever you want to do when the website is down.</span>
</pre></div>


<h3 id="246-restart-the-apache-server-remotely">2. Restart the Apache server remotely</h3>
<p>There is a wonderful Python library and a command-line tool called <em><a href="http://docs.fabfile.org/en/1.5/">Fabric</a></em> that helps you streamlining the use of SSH for application deployment or systems administration tasks. It is ideally used to automate tedious error prone tasks in an easy way.</p>
<p>You can read about more about it in their documentation.</p>
<p>Install it by running the following command:</p>
<div class="codehilite"><pre><span class="nv">$ </span>sudo apt-get install fabric
</pre></div>


<p>We now need to create a new python file that I will name <code>fabfile.py</code>, you can name it anything, but let's just follow the common name you will see in Fabric's documenation.</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span><span class="p">,</span> <span class="n">sudo</span>

<span class="n">env</span><span class="o">.</span><span class="n">hosts</span>       <span class="o">=</span> <span class="p">[</span><span class="s">&#39;user@server&#39;</span><span class="p">]</span>
<span class="n">env</span><span class="o">.</span><span class="n">passwords</span>   <span class="o">=</span> <span class="p">{</span><span class="s">&#39;user@server&#39;</span> <span class="p">:</span> <span class="s">&#39;password&#39;</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">restart_apache</span><span class="p">():</span>
    <span class="n">sudo</span><span class="p">(</span><span class="s">&quot;apache2ctl restart&quot;</span><span class="p">)</span>
</pre></div>


<p>We start by importing what we need from Fabric. Then we tell it some information about the server we want to restart Apache on by setting the <code>env.hosts</code> and <code>env.passwords</code> variables.</p>
<p>Then we define a <code>restart_apache</code> function that we will call later to do the actual restart.</p>
<p>There are three main functions that are used the most, <code>local()</code> that runs local commands, <code>run()</code> that runs commands on the remote server and <code>sudo()</code> that runs commands on the remote server using <code>sudo</code>. Since Apache restart requires a root user or sudo priveleges we used the <code>sudo()</code> function.</p>
<p>To run a Fabric script open up your terminal and run the following command:</p>
<div class="codehilite"><pre><span class="nv">$ </span>fabric fabfile.py restart_apache
</pre></div>


<p>If you want to run it from a different directory than the <code>fabfile.py</code> then you need to use the <code>-f</code> option like this :</p>
<div class="codehilite"><pre><span class="nv">$ </span>fabric -f /path/to/your/fabfile.py function_name
</pre></div>


<h3 id="346-alerting-the-devops-team-about-the-issue">3. Alerting the DevOps team about the issue.</h3>
<p>We can re-use the email function from the previous post on this blog <a href="http://www.mos3abof.com/installing-gdata-python-client-on-dreamhost.html">Installing Gdata Python Client on Dreamhost</a>:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">from</span> <span class="nn">email.MIMEMultipart</span> <span class="kn">import</span> <span class="n">MIMEMultipart</span>
<span class="kn">from</span> <span class="nn">email.MIMEBase</span> <span class="kn">import</span> <span class="n">MIMEBase</span>
<span class="kn">from</span> <span class="nn">email.MIMEText</span> <span class="kn">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span> <span class="nn">email</span> <span class="kn">import</span> <span class="n">Encoders</span>


<span class="n">subject</span>     <span class="o">=</span> <span class="s">&#39;Your website is down&#39;</span>
<span class="n">email_body</span>  <span class="o">=</span> <span class="s">&#39;Your website is down&#39;</span>
<span class="n">gmail_user</span>  <span class="o">=</span> <span class="s">&#39;YOUR-GMAIL-ADDRESS&#39;</span>
<span class="n">gmail_pwd</span>   <span class="o">=</span> <span class="s">&#39;YOUR-GMAIL-PASSWORD&#39;</span>
<span class="n">recepient</span>   <span class="o">=</span> <span class="s">&#39;DEVOPS-EMAIL&#39;</span>

<span class="k">def</span> <span class="nf">mail</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">gmail_user</span><span class="p">,</span> <span class="n">gmail_pwd</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sends mail using gmail</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">()</span>

    <span class="c"># Setting up message data</span>
    <span class="n">msg</span><span class="p">[</span><span class="s">&#39;From&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&#39;DEVOPS-EMAIL&#39;</span>
    <span class="n">msg</span><span class="p">[</span><span class="s">&#39;To&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">to</span>
    <span class="n">msg</span><span class="p">[</span><span class="s">&#39;Subject&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">subject</span>

    <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">MIMEText</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

    <span class="c"># Opening the connection with Gmail SMTP server</span>
    <span class="n">mailServer</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s">&quot;smtp.gmail.com&quot;</span><span class="p">,</span> <span class="mi">587</span><span class="p">)</span>
    <span class="n">mailServer</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
    <span class="n">mailServer</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
    <span class="n">mailServer</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
    <span class="n">mailServer</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">gmail_user</span><span class="p">,</span> <span class="n">gmail_pwd</span><span class="p">)</span>

    <span class="c"># Actual sending of the email</span>
    <span class="n">mailServer</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">gmail_user</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>

    <span class="c"># Closing the connection</span>
    <span class="c"># Should be mailServer.quit(), but that crashes</span>
    <span class="n">mailServer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<h3 id="446-putting-it-all-together">4. Putting it all together</h3>
<p>I have combined all the snippets mentioned above, modified them and added some logging functionality to it.</p>
<p>I have it installed on <code>/opt/fabfile.py</code> and I have created a <code>/opt/fab_logs</code> folder to hold the log files.</p>
<p>Below is how a complete script may look like.</p>
<div class="gist">
    <script src='https://gist.github.com/4771874.js'></script>
    <noscript>
        <pre><code>#!/usr/bin/python
# -*- coding: utf-8 -*-
 
# Import DateTime
from datetime import datetime, timedelta, date
 
# Import urllib
import urllib
 
# Importing utilities from Fabric
from fabric.api import env, sudo
 
# Import email stuff
import smtplib
from email.MIMEMultipart import MIMEMultipart
from email.MIMEBase import MIMEBase
from email.MIMEText import MIMEText
from email import Encoders
 
# For debugging purposes
import traceback
 
# Import Logging lib
import logging
 
# Setting up Logging 
current_date 			= date.today()
current_log_file_name 		= '/opt/fab_logs/' + current_date.isoformat() + '.log'
logging.basicConfig( format 	= '%(asctime)s [%(levelname)s] %(message)s', 
		    filename 	= current_log_file_name, 
		    level 	= logging.INFO)
 
# Defining the env.hosts
env.hosts 	= ['username@server-address']
env.passwords 	= {'username@server-address' : 'passoword' }
 
 
# The function that actually sends email
def mail(to, subject, text, gmail_user, gmail_pwd):
	'''
	Sends mail using gmail
	'''
	msg = MIMEMultipart()
 
	# Setting up message data
	msg['From'] 	= 'alterts@yoursite.com'
	msg['To'] 	= to
	msg['Subject']	= subject
 
	msg.attach(MIMEText(text))
 
	# Opening the connection with Gmail SMTP server
	mailServer = smtplib.SMTP("smtp.gmail.com", 587)
	mailServer.ehlo()
	mailServer.starttls()
	mailServer.ehlo()
	mailServer.login(gmail_user, gmail_pwd)
 
	# Actual sending of the email
	mailServer.sendmail(gmail_user, to, msg.as_string())
	
	# Closing the connection
	# Should be mailServer.quit(), but that crashes
	mailServer.close()
 
# Alerting the DevOps Team
def alert_dev_team(message = ''):
	'''
	This functions emails the DevOps Team that there is a downtime
	'''
	# Constructing the email message
	subject		= 'YOUR WEBSITE IS DOWN'
	email_body	= 'YOUR WEBSITE IS DOWN. \nTime now is {} \n{}'.format(date.today().isoformat(), message)
	gmail_user	= 'GMAIL-USERNAME'
	gmail_pwd	= 'PASSWORD'
	logging.debug("Constructed Email message")
	recepient 	= 'alerts@yoursite.com'

	# Sending the message
	mail(recepient, subject,  email_body, gmail_user, gmail_pwd)
	logging.debug("Finished sending all messages")
 
 
# Let the magic begin
def restart_apache():
	'''
	Checks if Apache2 server on YOUR WEBSITE is accessible through the web.
	If not it attemptes to restart it and alert the Dev Team.
 
	It should be added to cron to run every 5 minutes like this :
 
	*/5 * * * * /usr/bin/fab -f /opt/fabfile.py restart_apache
	'''
 
	try:
		logging.info("The script was invoked by the cron")
 
		# Open the site using urllib
		result = urllib.urlopen("http://www.yourwebsite.com").getcode()
 
		# if the alue of the respsonse is not 200 then raise an error
		if not result == 200:
			raise ValueError
		# Log the attempt and successful result
		logging.info("The result came back {}".format(result))
		logging.info("Everything seems fine! Over and out!")
 
	# if we don't get a response at all or the value is not 200 OK then start the mechanism
	except:
		# Something with the wsbite is not right, attempt to restart the Apache server
		logging.error("Houston, we have got a problem! Attempting an Apache restart")
		logging.debug(traceback.format_exc())
		
		# setup the message to email to DevOps team
		message = 'Restart attempt complete. Everything should be fine now'
 
		try:
			# restart apache using sudo
			sudo('apache2ctl restart')
 
		except:
			# If the restart attempt fails we should know!
			logging.error("WE FAILED! The script couldn't restart the Apache. Human intervention needed!")
			logging.error(traceback.format_exc())
			message = "WE FAILED! The script couldn't restart the Apache. Human intervention needed!"
 
		try:
			# Attempt to alert the DevOps team
			alert_dev_team(message)
			logging.info("Sending an email to alerts@yoursite.com")
		except:
			logging.error('Tried sending an email and failed!')
		logging.info("Restart attempt complete. Everything should be fine now")</code></pre>
    </noscript>
</div>
<h3 id="546-setting-up-a-cron-job-to-run-the-script">5. Setting up a cron job to run the script</h3>
<p>Now we have a great script, and we know how to run it manually. But it would be invonvenient to run it manually all the time. We need to setup a cron job to do it periodically for us.</p>
<p>Run the following command in the terminal to edit your crontab file:</p>
<div class="codehilite"><pre>crontab -e
</pre></div>


<p>Then add the following line to the file to run the script every hour:</p>
<div class="codehilite"><pre>0 * * * * /usr/bin/fab -f /path/to/your/fabfile.py restart_apache
</pre></div>


<p>Happy website monitoring.</p></p>

    <hr>

    <div class=social-controls>

    <div class="fb-like" data-href="http://www.mos3abof.com/poor-man-website-python-monitor.html" data-send="true" data-width="400" data-show-faces="true"></div>

    
</div>
        <h2>Comments</h2>
    <div id=disqus_thread></div>
<script>script('http://mos3abof.disqus.com/embed.js')</script>
<noscript>Please enable JavaScript to view comments.</noscript>    </article>
    </article>

    <hr />

    <footer>
        <p>
            Site is built using
            <a href="http://docs.getpelican.com/en/latest/getting_started.html" target="_blank">Pelican</a>
            (static site generator, written in <a href="http://www.python.org" target="_blank">Python</a>),
            runs on <a href="https://developers.google.com/appengine/" target="_blank">Google AppEngine</a>,
            icons by <a href="http://simpleicons.org/" target="_blank">Simple Icons</a>
            and uses <a href="https://github.com/sharat87/sharats.me" target="_blank">Shrikant Sharat</a>'s theme.
            <br />
            &copy; All rights reserved to <a href="http://www.mos3abof.com">Mosab Ahmad</a> 2007 - 2013
        </p>
        <section class=social>
            <a href="./feeds/all.atom.xml" target=_blank>
                <img src="theme/img/rss.png" style="color: #FF8300; background-color: #FF8300;">
            </a>
            <a href="http://facebook.com/mos3abof" target=_blank>
                <img style="color:#3B5998; background-color: #3B5998;"  src="theme/img/facebook.png" />
            </a>
            <a href="http://twitter.com/mos3abof" target=_blank>
                <img src="theme/img/twitter.png" style="color: #00ACED; background-color: #00ACED;">
            </a>
            <a href="http://github.com/mos3abof" target=_blank>
                <img src="theme/img/github.png" style="color: #4183C4; background-color: #4183C4;">
            </a>
            <a href="https://plus.google.com/103419053954297467507" target=_blank>
                <img src="theme/img/googleplus.png" style="color: #D14836; background-color: #D14836;">
            </a>
            <a href="http://stackoverflow.com/users/253214/mosab-ahmad" target=_blank>
                <img src="theme/img/stackoverflow.png" style="color: #F47920; background-color: #F47920;">
            </a>
        </section>
    </footer>
</section>

<script>script('//static.getclicky.com/js')</script>
<noscript><img width=1 height=1 src="//in.getclicky.com/100601461ns.gif"></noscript><script async src="http://www.mos3abof.com/theme/main.js"></script>